# <%= appTitle %>

<% for (let channelName in channels) { -%>
    <% const channel = channels[channelName]; %>
## Channel '<%= channelName %>' Example

<%= channel.description() %>

```php
<?php

require_once(__DIR__ . '/vendor/autoload.php');

<% if (server.protocol() === 'amqp') { -%>
use AsyncAPI\Services\MessageBroker\AMQP\AMQPClientConfig;
use AsyncAPI\Services\MessageBroker\AMQP\AMQPClient;
<% } -%>

use React\EventLoop\Loop;
use Rx\Scheduler;

use <%= servicesNamespace %>\Channels\<%= channelName.charAt(0).toUpperCase() + channelName.slice(1) %>Channel;
<%
const subscribeOperationClass = classHierarchy.getClass(channel.subscribe().message().payload().uid()); 
-%>

use <%= subscribeOperationClass.getPackageName() %>\<%= subscribeOperationClass.getName() %>;
<% for (const subClass of subscribeOperationClass.getSubClasses()) { -%>
use <%= subClass.getPackageName() %>\<%= subClass.getName() %>;
<% } -%>

$loop = Loop::get();

// You only need to set the default scheduler once
Scheduler::setDefaultFactory(function () use ($loop) {
    return new Scheduler\EventLoopScheduler($loop);
});

<%
if (server.protocol() === 'amqp' && server.protocolVersion() === '0.9.1') {
    for (const serverSecuritySchema of serverSecuritySchemes) {
        const USER_PASSWORD_SECURITY_SCHEME_TYPE = 'userPassword';
        if (serverSecuritySchema.type() === USER_PASSWORD_SECURITY_SCHEME_TYPE) {
            -%>
$username = 'user';
$password = 'password';
$config = new AMQPClientConfig('<%= server.url().split(':')[0] -%>', <%= server.url().split(':')[1] -%>, $username, $password);
$client = new AMQPClient($config);
            <%
        }
    }
} 
-%>

$client->connect();

$<%= channelName %>Channel = new <%= channelName.charAt(0).toUpperCase() + channelName.slice(1) %>Channel($client);

$<%= channelName %>Channel-><%= channel.subscribe().id() %>()->subscribe(function (<%= subscribeOperationClass.getName() %> $<%= subscribeOperationClass.getName().charAt(0).toLowerCase() + subscribeOperationClass.getName().slice(1) %>) {
    echo "[x] Received a <%= subscribeOperationClass.getName() %> object:\n";
    print_r($<%= subscribeOperationClass.getName().charAt(0).toLowerCase() + subscribeOperationClass.getName().slice(1) %>);
});

<% for (const subClass of subscribeOperationClass.getSubClasses()) { -%>
$<%= channelName %>Channel-><%= subClass.getName().charAt(0).toLowerCase() + subClass.getName().slice(1) %>->subscribe(function (<%= subClass.getName() %> $<%= subClass.getName().charAt(0).toLowerCase() + subClass.getName().slice(1) %>) {
    echo "[x] Received a <%= subClass.getName() %> object:\n";
    print_r($<%= subClass.getName().charAt(0).toLowerCase() + subClass.getName().slice(1) %>);
});
<% } -%>

$<%= channelName %>Channel->listen();
```
<% } %>